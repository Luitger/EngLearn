from flask import Flask, render_template, request, jsonify, session
from flask_cors import CORS
from datetime import datetime, timedelta
import hashlib
import secrets
import json
import os

app = Flask(__name__)
app.secret_key = os.environ.get('SECRET_KEY', secrets.token_hex(32))
CORS(app, supports_credentials=True)

# Veritabanƒ± - SQLite (basit ve her yerde √ßalƒ±≈üƒ±r)
import sqlite3
DB_PATH = 'kelime_app.db'

def get_db():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn

# Veritabanƒ± ba≈ülatma
def init_db():
    conn = get_db()
    c = conn.cursor()
    
    c.execute('''CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE NOT NULL,
        password TEXT NOT NULL,
        email TEXT,
        avatar TEXT DEFAULT 'girl1',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )''')
    
    c.execute('''CREATE TABLE IF NOT EXISTS learned_words (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        word_english TEXT,
        learned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        review_count INTEGER DEFAULT 0,
        next_review TIMESTAMP,
        ease_factor REAL DEFAULT 2.5,
        FOREIGN KEY (user_id) REFERENCES users(id)
    )''')
    
    c.execute('''CREATE TABLE IF NOT EXISTS test_results (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        score INTEGER,
        total_questions INTEGER,
        completed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id)
    )''')
    
    c.execute('''CREATE TABLE IF NOT EXISTS daily_activity (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        date DATE,
        words_learned INTEGER DEFAULT 0,
        tests_completed INTEGER DEFAULT 0,
        study_time INTEGER DEFAULT 0,
        FOREIGN KEY (user_id) REFERENCES users(id),
        UNIQUE(user_id, date)
    )''')
    
    conn.commit()
    conn.close()
    print("‚úì Veritabanƒ± hazƒ±r (SQLite)")

def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()

@app.route('/api/register', methods=['POST'])
def register():
    data = request.json
    username = data.get('username')
    password = data.get('password')
    email = data.get('email', '')
    avatar = data.get('avatar', 'girl1')
    
    if not username or not password:
        return jsonify({'success': False, 'message': 'Kullanƒ±cƒ± adƒ± ve ≈üifre gerekli'}), 400
    
    conn = get_db()
    c = conn.cursor()
    
    try:
        if False:
            c.execute('INSERT INTO users (username, password, email, avatar) VALUES (%s, %s, %s, %s) RETURNING id',
                      (username, hash_password(password), email, avatar))
            user_id = c.fetchone()['id']
        else:
            c.execute('INSERT INTO users (username, password, email, avatar) VALUES (?, ?, ?, ?)',
                      (username, hash_password(password), email, avatar))
            user_id = c.lastrowid
        
        conn.commit()
        session['user_id'] = user_id
        session['username'] = username
        session['avatar'] = avatar
        return jsonify({'success': True, 'message': 'Kayƒ±t ba≈üarƒ±lƒ±', 'user_id': user_id, 'avatar': avatar})
    except Exception as e:
        conn.rollback()
        print(f"Kayƒ±t hatasƒ±: {e}")
        return jsonify({'success': False, 'message': 'Bu kullanƒ±cƒ± adƒ± zaten kullanƒ±lƒ±yor'}), 400
    finally:
        conn.close()

@app.route('/api/login', methods=['POST'])
def login():
    data = request.json
    username = data.get('username')
    password = data.get('password')
    
    conn = get_db()
    c = conn.cursor()
    
    if False:
        c.execute('SELECT id, username, avatar FROM users WHERE username = %s AND password = %s',
                  (username, hash_password(password)))
    else:
        c.execute('SELECT id, username, avatar FROM users WHERE username = ? AND password = ?',
                  (username, hash_password(password)))
    
    user = c.fetchone()
    conn.close()
    
    if user:
        session['user_id'] = user['id'] if False else user[0]
        session['username'] = user['username'] if False else user[1]
        session['avatar'] = user['avatar'] if False else (user[2] if len(user) > 2 else 'girl1')
        return jsonify({'success': True, 'message': 'Giri≈ü ba≈üarƒ±lƒ±', 'username': session['username'], 'avatar': session['avatar']})
    else:
        return jsonify({'success': False, 'message': 'Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±'}), 401

@app.route('/api/logout', methods=['POST'])
def logout():
    session.clear()
    return jsonify({'success': True, 'message': '√áƒ±kƒ±≈ü yapƒ±ldƒ±'})

@app.route('/api/user', methods=['GET'])
def get_user():
    if 'user_id' in session:
        return jsonify({
            'logged_in': True,
            'user_id': session['user_id'],
            'username': session['username'],
            'avatar': session.get('avatar', 'girl1')
        })
    return jsonify({'logged_in': False})

@app.route('/api/update-avatar', methods=['POST'])
def update_avatar():
    if 'user_id' not in session:
        return jsonify({'success': False, 'message': 'Giri≈ü yapmalƒ±sƒ±nƒ±z'}), 401
    
    data = request.json
    avatar = data.get('avatar')
    user_id = session['user_id']
    
    conn = get_db()
    c = conn.cursor()
    
    if False:
        c.execute('UPDATE users SET avatar = %s WHERE id = %s', (avatar, user_id))
    else:
        c.execute('UPDATE users SET avatar = ? WHERE id = ?', (avatar, user_id))
    
    conn.commit()
    conn.close()
    
    session['avatar'] = avatar
    return jsonify({'success': True, 'message': 'Avatar g√ºncellendi', 'avatar': avatar})

@app.route('/api/learn-word', methods=['POST'])
def learn_word():
    if 'user_id' not in session:
        return jsonify({'success': False, 'message': 'Giri≈ü yapmalƒ±sƒ±nƒ±z'}), 401
    
    data = request.json
    word_english = data.get('word')
    user_id = session['user_id']
    
    conn = get_db()
    c = conn.cursor()
    
    if False:
        c.execute('SELECT id, review_count, ease_factor FROM learned_words WHERE user_id = %s AND word_english = %s',
                  (user_id, word_english))
    else:
        c.execute('SELECT id, review_count, ease_factor FROM learned_words WHERE user_id = ? AND word_english = ?',
                  (user_id, word_english))
    
    existing = c.fetchone()
    
    if existing:
        review_count = (existing['review_count'] if False else existing[1]) + 1
        ease_factor = existing['ease_factor'] if False else existing[2]
        
        if review_count == 1:
            interval = 1
        elif review_count == 2:
            interval = 6
        else:
            interval = int(6 * ease_factor)
        
        next_review = datetime.now() + timedelta(days=interval)
        word_id = existing['id'] if False else existing[0]
        
        if False:
            c.execute('UPDATE learned_words SET review_count = %s, next_review = %s, ease_factor = %s WHERE id = %s',
                      (review_count, next_review, ease_factor, word_id))
        else:
            c.execute('UPDATE learned_words SET review_count = ?, next_review = ?, ease_factor = ? WHERE id = ?',
                      (review_count, next_review, ease_factor, word_id))
    else:
        next_review = datetime.now() + timedelta(days=1)
        if False:
            c.execute('INSERT INTO learned_words (user_id, word_english, next_review) VALUES (%s, %s, %s)',
                      (user_id, word_english, next_review))
        else:
            c.execute('INSERT INTO learned_words (user_id, word_english, next_review) VALUES (?, ?, ?)',
                      (user_id, word_english, next_review))
        
        today = datetime.now().date()
        if False:
            c.execute('''INSERT INTO daily_activity (user_id, date, words_learned) 
                         VALUES (%s, %s, 1)
                         ON CONFLICT (user_id, date) 
                         DO UPDATE SET words_learned = daily_activity.words_learned + 1''',
                      (user_id, today))
        else:
            c.execute('''INSERT INTO daily_activity (user_id, date, words_learned) 
                         VALUES (?, ?, 1)
                         ON CONFLICT(user_id, date) 
                         DO UPDATE SET words_learned = words_learned + 1''',
                      (user_id, today))
    
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'message': 'Kelime kaydedildi'})

@app.route('/api/learned-words', methods=['GET'])
def get_learned_words():
    if 'user_id' not in session:
        return jsonify({'success': False, 'message': 'Giri≈ü yapmalƒ±sƒ±nƒ±z'}), 401
    
    user_id = session['user_id']
    conn = get_db()
    c = conn.cursor()
    
    if False:
        c.execute('''SELECT word_english, learned_at, review_count, next_review 
                     FROM learned_words 
                     WHERE user_id = %s 
                     ORDER BY learned_at DESC''', (user_id,))
    else:
        c.execute('''SELECT word_english, learned_at, review_count, next_review 
                     FROM learned_words 
                     WHERE user_id = ? 
                     ORDER BY learned_at DESC''', (user_id,))
    
    words = []
    for row in c.fetchall():
        words.append({
            'word': row['word_english'] if False else row[0],
            'learned_at': row['learned_at'] if False else row[1],
            'review_count': row['review_count'] if False else row[2],
            'next_review': row['next_review'] if False else row[3]
        })
    
    conn.close()
    return jsonify({'success': True, 'words': words})

@app.route('/api/review-words', methods=['GET'])
def get_review_words():
    if 'user_id' not in session:
        return jsonify({'success': False, 'message': 'Giri≈ü yapmalƒ±sƒ±nƒ±z'}), 401
    
    user_id = session['user_id']
    conn = get_db()
    c = conn.cursor()
    
    now = datetime.now()
    if False:
        c.execute('''SELECT word_english, next_review 
                     FROM learned_words 
                     WHERE user_id = %s AND next_review <= %s 
                     ORDER BY next_review ASC''', (user_id, now))
    else:
        c.execute('''SELECT word_english, next_review 
                     FROM learned_words 
                     WHERE user_id = ? AND next_review <= ? 
                     ORDER BY next_review ASC''', (user_id, now))
    
    words = [{'word': row['word_english'] if False else row[0], 
              'next_review': row['next_review'] if False else row[1]} 
             for row in c.fetchall()]
    
    conn.close()
    return jsonify({'success': True, 'words': words, 'count': len(words)})

@app.route('/api/save-test', methods=['POST'])
def save_test():
    if 'user_id' not in session:
        return jsonify({'success': False, 'message': 'Giri≈ü yapmalƒ±sƒ±nƒ±z'}), 401
    
    data = request.json
    score = data.get('score')
    total = data.get('total')
    user_id = session['user_id']
    
    conn = get_db()
    c = conn.cursor()
    
    if False:
        c.execute('INSERT INTO test_results (user_id, score, total_questions) VALUES (%s, %s, %s)',
                  (user_id, score, total))
    else:
        c.execute('INSERT INTO test_results (user_id, score, total_questions) VALUES (?, ?, ?)',
                  (user_id, score, total))
    
    today = datetime.now().date()
    if False:
        c.execute('''INSERT INTO daily_activity (user_id, date, tests_completed) 
                     VALUES (%s, %s, 1)
                     ON CONFLICT (user_id, date) 
                     DO UPDATE SET tests_completed = daily_activity.tests_completed + 1''',
                  (user_id, today))
    else:
        c.execute('''INSERT INTO daily_activity (user_id, date, tests_completed) 
                     VALUES (?, ?, 1)
                     ON CONFLICT(user_id, date) 
                     DO UPDATE SET tests_completed = tests_completed + 1''',
                  (user_id, today))
    
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'message': 'Test sonucu kaydedildi'})

@app.route('/api/stats', methods=['GET'])
def get_stats():
    if 'user_id' not in session:
        return jsonify({'success': False, 'message': 'Giri≈ü yapmalƒ±sƒ±nƒ±z'}), 401
    
    user_id = session['user_id']
    conn = get_db()
    c = conn.cursor()
    
    if False:
        c.execute('SELECT COUNT(*) as count FROM learned_words WHERE user_id = %s', (user_id,))
        total_words = c.fetchone()['count']
        
        c.execute('SELECT COUNT(*) as count FROM test_results WHERE user_id = %s', (user_id,))
        total_tests = c.fetchone()['count']
        
        c.execute('SELECT AVG(CAST(score AS FLOAT) / total_questions * 100) as avg FROM test_results WHERE user_id = %s', (user_id,))
        avg_score = c.fetchone()['avg'] or 0
    else:
        c.execute('SELECT COUNT(*) FROM learned_words WHERE user_id = ?', (user_id,))
        total_words = c.fetchone()[0]
        
        c.execute('SELECT COUNT(*) FROM test_results WHERE user_id = ?', (user_id,))
        total_tests = c.fetchone()[0]
        
        c.execute('SELECT AVG(CAST(score AS FLOAT) / total_questions * 100) FROM test_results WHERE user_id = ?', (user_id,))
        avg_score = c.fetchone()[0] or 0
    
    seven_days_ago = (datetime.now() - timedelta(days=7)).date()
    if False:
        c.execute('''SELECT date, words_learned, tests_completed 
                     FROM daily_activity 
                     WHERE user_id = %s AND date >= %s 
                     ORDER BY date DESC''', (user_id, seven_days_ago))
    else:
        c.execute('''SELECT date, words_learned, tests_completed 
                     FROM daily_activity 
                     WHERE user_id = ? AND date >= ? 
                     ORDER BY date DESC''', (user_id, seven_days_ago))
    
    daily_stats = []
    for row in c.fetchall():
        daily_stats.append({
            'date': str(row['date'] if False else row[0]),
            'words_learned': row['words_learned'] if False else row[1],
            'tests_completed': row['tests_completed'] if False else row[2]
        })
    
    if False:
        c.execute('''SELECT date FROM daily_activity 
                     WHERE user_id = %s 
                     ORDER BY date DESC''', (user_id,))
    else:
        c.execute('''SELECT date FROM daily_activity 
                     WHERE user_id = ? 
                     ORDER BY date DESC''', (user_id,))
    
    dates = [str(row['date'] if False else row[0]) for row in c.fetchall()]
    streak = 0
    if dates:
        current_date = datetime.now().date()
        for date_str in dates:
            date = datetime.strptime(date_str, '%Y-%m-%d').date()
            if date == current_date or date == current_date - timedelta(days=streak):
                streak += 1
                current_date = date
            else:
                break
    
    conn.close()
    
    return jsonify({
        'success': True,
        'total_words': total_words,
        'total_tests': total_tests,
        'avg_score': round(avg_score, 1),
        'streak': streak,
        'daily_stats': daily_stats
    })

@app.route('/api/leaderboard', methods=['GET'])
def get_leaderboard():
    conn = get_db()
    c = conn.cursor()
    
    if False:
        c.execute('''SELECT u.username, COUNT(lw.id) as word_count, 
                     AVG(CAST(tr.score AS FLOAT) / tr.total_questions * 100) as avg_score
                     FROM users u
                     LEFT JOIN learned_words lw ON u.id = lw.user_id
                     LEFT JOIN test_results tr ON u.id = tr.user_id
                     GROUP BY u.id, u.username
                     ORDER BY word_count DESC, avg_score DESC
                     LIMIT 10''')
    else:
        c.execute('''SELECT u.username, COUNT(lw.id) as word_count, 
                     AVG(CAST(tr.score AS FLOAT) / tr.total_questions * 100) as avg_score
                     FROM users u
                     LEFT JOIN learned_words lw ON u.id = lw.user_id
                     LEFT JOIN test_results tr ON u.id = tr.user_id
                     GROUP BY u.id
                     ORDER BY word_count DESC, avg_score DESC
                     LIMIT 10''')
    
    leaderboard = []
    for i, row in enumerate(c.fetchall(), 1):
        leaderboard.append({
            'rank': i,
            'username': row['username'] if False else row[0],
            'words_learned': row['word_count'] if False else row[1],
            'avg_score': round((row['avg_score'] if False else row[2]) or 0, 1)
        })
    
    conn.close()
    return jsonify({'success': True, 'leaderboard': leaderboard})

@app.route('/')
def index():
    return render_template('index.html')

if __name__ == '__main__':
    init_db()
    port = int(os.environ.get('PORT', 5000))
    print(f"üöÄ Kelime √ñƒürenme Uygulamasƒ±")
    print(f"üìä Veritabanƒ±: {DATABASE_TYPE}")
    print(f"üåê Port: {port}")
    app.run(debug=False, host='0.0.0.0', port=port)
else:
    # Gunicorn ile √ßalƒ±≈üƒ±rken
    init_db()

